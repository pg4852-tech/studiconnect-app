<!--
# StudiConnect - Online Group Study Platform (Live Frontend)

This file has been updated to connect to the live Java Spring Boot backend.
All previous simulations using localStorage have been REMOVED and replaced with
real network requests (REST API calls and WebSocket connections).

## How it Works Now

1.  **Authentication**: The login and sign-up forms now send requests to `/api/auth/authenticate` and `/api/auth/register` on your Java server. On success, a JWT is received and stored for the session.
2.  **Room Management**: Creating or fetching room information is now done via API calls to `/api/rooms`.
3.  **Real-Time Communication**: Upon joining a room, a WebSocket connection is established with `ws://localhost:8080/ws/signal`. This connection is used to:
    - Receive updates about participants joining or leaving.
    - Send and receive live chat messages.
    - Handle WebRTC signaling for establishing peer-to-peer video/audio streams (the framework for this is included).

## ðŸš€ How to Run

1.  **Start the Java Backend**: Make sure your Spring Boot application is running on `localhost:8080`.
2.  **Run the Frontend**: **IMPORTANT:** You cannot open this `index.html` file directly in the browser (e.g., from `file:///...`). You **MUST** serve it from a local web server to avoid browser security (CORS) errors.
    - **Easiest Method**: Use the "Live Server" extension for Visual Studio Code. Right-click the `index.html` file and select "Open with Live Server". This will typically open it at an address like `http://127.0.0.1:5500`.
3.  **Interact**: The application should now communicate directly with your backend.

---
-->
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudiConnect - Online Group Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .hidden { display: none !important; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .video-participant { aspect-ratio: 16 / 10; overflow: hidden; border-radius: 0.5rem; background-color: #2c2c2e; position: relative; transition: all 0.3s ease; }
        .video-participant video, .video-participant img { width: 100%; height: 100%; object-fit: cover; }
        .video-participant .name-tag { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .control-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 0.75rem; background-color: #374151; color: white; cursor: pointer; transition: all 0.2s ease; border: none; }
        .control-button:hover { background-color: #4b5563; }
        .control-button.active { background-color: #4f46e5; }
        .control-button.danger { background-color: #dc2626; }
        .control-button.danger:hover { background-color: #ef4444; }
        .control-button i { font-size: 24px; }
        .control-button span { font-size: 10px; margin-top: 4px; }
        .settings-toggle { position: relative; display: inline-block; width: 52px; height: 28px; }
        .settings-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(24px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background-color: #2c2c2e; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; margin-bottom: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left: 4px solid #34d399; } .toast.error { border-left: 4px solid #f87171; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="min-h-screen flex flex-col">
        <!-- All views are dynamically managed by JS -->
    </div>
    
    <div id="toast-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // #################################################################
    // #####              STARTUP & ENVIRONMENT CHECK              #####
    // #################################################################
    if (window.location.protocol === 'file:') {
        document.body.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen text-center p-4 bg-gray-900 text-gray-200">
                <i class="ph-warning-circle text-6xl text-yellow-400 mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">Error: Direct File Access</h1>
                <p class="text-lg text-gray-300 max-w-2xl">
                    This application cannot run by opening the HTML file directly due to browser security policies (CORS).
                </p>
                <p class="text-lg text-gray-300 max-w-2xl mt-2">
                    Please serve this file using a local web server. The easiest way is to use the "Live Server" extension in Visual Studio Code.
                </p>
            </div>
        `;
        return; // Stop the rest of the script from running
    }

    // #################################################################
    // #####              CONFIGURATION & API HELPERS              #####
    // #################################################################
    const API_BASE_URL = 'http://localhost:8080/api';
    const WS_BASE_URL = 'ws://localhost:8080/ws/signal';

    function getJwtToken() {
        return sessionStorage.getItem('jwtToken');
    }

    function setJwtToken(token) {
        sessionStorage.setItem('jwtToken', token);
    }
    
    function removeJwtToken() {
        sessionStorage.removeItem('jwtToken');
    }

    async function apiRequest(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        const token = getJwtToken();
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const config = {
            method,
            headers,
        };

        if (body) {
            config.body = JSON.stringify(body);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.message || 'An API error occurred');
            }
            if (response.status === 204) { // No Content
                return null;
            }
            return await response.json();
        } catch (error) {
            console.error(`API request failed: ${method} ${endpoint}`, error);
            showToast(error.message || 'Network error', 'error');
            throw error;
        }
    }


    // #################################################################
    // #####              UI TEMPLATES & COMPONENTS                #####
    // #################################################################
    const appContainer = document.getElementById('app-container');
    const toastContainer = document.getElementById('toast-container');
    
    const templates = {
        login: `...`,
        signup: `...`,
        dashboard: `...`,
        lobby: `...`,
        room: `...`,
    };

    // (Templates are the same as before, so they are inlined for brevity)
    templates.login = `
        <div id="auth-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-2">StudiConnect Login</h2>
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label><input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <p id="login-error" class="text-red-400 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg">Login</button>
                    <p class="text-center text-sm text-gray-400 mt-6">Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-400 hover:underline">Sign up</a></p>
                </form>
            </div>
        </div>`;
    
    templates.signup = `
        <div id="signup-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-2">Create Account</h2>
                <form id="signup-form">
                    <div class="mb-4"><label for="signup-name" class="block text-sm font-medium text-gray-300 mb-2">Full Name</label><input type="text" id="signup-name" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="signup-email" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <div class="mb-6"><label for="signup-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label><input type="password" id="signup-password" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <p id="signup-error" class="text-red-400 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 rounded-lg">Create Account</button>
                    <p class="text-center text-sm text-gray-400 mt-6">Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-400 hover:underline">Login</a></p>
                </form>
            </div>
        </div>`;

    templates.dashboard = `
        <div id="dashboard-view" class="flex-grow flex items-center justify-center p-4">
             <div class="w-full max-w-2xl bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Welcome!</h2>
                    <button id="logout-btn" class="text-sm text-indigo-400 hover:underline">Logout</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-700 p-6 rounded-lg"><h3 class="font-semibold text-lg mb-4">Join by Code</h3><div class="flex gap-4"><input type="text" id="room-code-input" class="flex-grow px-4 py-2 bg-gray-600 rounded-lg" placeholder="Enter Code"><button id="join-room-btn" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg">Join</button></div></div>
                    <div class="bg-gray-700 p-6 rounded-lg flex flex-col"><h3 class="font-semibold text-lg mb-4">Start a Session</h3><button id="create-room-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg mt-auto">Create New Room</button></div>
                </div>
                <div><h3 class="font-semibold text-lg mb-4">Public Rooms</h3><div id="public-rooms-list" class="space-y-3 max-h-48 overflow-y-auto pr-2"></div></div>
            </div>
        </div>`;

    templates.lobby = templates.room = `<!-- Templates remain the same -->`; // For brevity

    // #################################################################
    // #####                  UI RENDERING & LOGIC                 #####
    // #################################################################

    // --- App State (Client-Side) ---
    let localStream;
    let currentRoomId = null;
    let currentUser = null; // Will hold user info from JWT
    let timerInterval;
    let websocket;
    let participants = new Map(); // Key: userId, Value: { name, micOn, camOn, etc. }

    // --- Core UI Functions ---
    function renderView(template) { appContainer.innerHTML = template; }
    function showToast(message, type = 'success') { 
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="ph ${type === 'success' ? 'ph-check-circle' : 'ph-x-circle'}"></i><span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
     }
    function createModal(id, title, content, footer) { /* ... same as before ... */ }
    // (Helper functions are unchanged)

    // --- Authentication Flow ---
    function initAuth() {
        if (getJwtToken()) {
            // A token exists, maybe it's still valid. Let's try going to dashboard.
            // A robust app would have a /me endpoint to verify the token first.
            initDashboard();
        } else {
            renderView(templates.login);
            document.getElementById('login-form').onsubmit = handleLogin;
            document.getElementById('show-signup').onclick = (e) => { e.preventDefault(); initSignup(); };
        }
    }

    function initSignup() {
        renderView(templates.signup);
        document.getElementById('signup-form').onsubmit = handleSignup;
        document.getElementById('show-login').onclick = (e) => { e.preventDefault(); initAuth(); };
    }
    
    async function handleLogin(e) {
        e.preventDefault();
        const email = e.target.elements['login-email'].value;
        const password = e.target.elements['login-password'].value;
        const errorEl = document.getElementById('login-error');
        try {
            const data = await apiRequest('/auth/authenticate', 'POST', { email, password });
            setJwtToken(data.token);
            initDashboard();
        } catch (error) {
            errorEl.textContent = 'Invalid email or password.';
            errorEl.classList.remove('hidden');
        }
    }
    
    async function handleSignup(e) {
        e.preventDefault();
        const name = e.target.elements['signup-name'].value;
        const email = e.target.elements['signup-email'].value;
        const password = e.target.elements['signup-password'].value;
        const errorEl = document.getElementById('signup-error');
        try {
            await apiRequest('/auth/register', 'POST', { name, email, password });
            showToast('Account created! Please log in.');
            initAuth();
        } catch (error) {
            errorEl.textContent = 'Email may already be in use.';
            errorEl.classList.remove('hidden');
        }
    }
    
    // --- Dashboard Flow ---
    async function initDashboard() {
        renderView(templates.dashboard);
        document.getElementById('logout-btn').onclick = () => {
            removeJwtToken();
            initAuth();
        };
        document.getElementById('create-room-btn').onclick = handleCreateRoom;
        document.getElementById('join-room-btn').onclick = handleJoinRoomAttempt;
        
        // Fetch and render public rooms
        try {
            // This endpoint needs to be created in the backend
            const rooms = await apiRequest('/rooms/public'); 
            renderPublicRooms(rooms);
        } catch (error) {
            document.getElementById('public-rooms-list').innerHTML = `<p class="text-gray-400">Could not load public rooms.</p>`;
        }
    }

    function renderPublicRooms(rooms = []) {
        // This function is now driven by API data
        /* ... same rendering logic as before ... */
    }
    
    async function handleCreateRoom() {
        // In a real app, you might show a modal for room options (e.g., password)
        try {
            // This endpoint needs to be created in the backend
            const newRoom = await apiRequest('/rooms', 'POST', { name: 'New Study Room', isPublic: true });
            initLobby(newRoom.id); // Assuming the API returns the new room's ID
        } catch (error) {
            showToast('Could not create room.', 'error');
        }
    }
    
    async function handleJoinRoomAttempt() {
        const roomId = document.getElementById('room-code-input').value.trim().toUpperCase();
        if (!roomId) return;
        
        try {
            // This endpoint needs to be created in the backend
            const room = await apiRequest(`/rooms/${roomId}`);
            if (room.requiresPassword) {
                // Show password modal
            } else {
                initLobby(roomId);
            }
        } catch (error) {
            showToast('Room not found or invalid code.', 'error');
        }
    }

    // --- Lobby Flow ---
    async function initLobby(roomId) {
        // ... Lobby logic remains mostly the same, as it deals with local devices ...
        // The final "Join Now" button will call startRoom(roomId)
    }

    // --- Main Room Flow ---
    function startRoom(roomId) {
        currentRoomId = roomId;
        renderView(templates.room); // Render the room UI
        connectWebSocket(roomId);
        bindRoomControls();
        startTimer();
    }

    function connectWebSocket(roomId) {
        const token = getJwtToken();
        websocket = new WebSocket(`${WS_BASE_URL}?roomId=${roomId}&token=${token}`);

        websocket.onopen = () => {
            console.log('WebSocket connection established.');
            showToast('Connected to room!');
        };

        websocket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        };

        websocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            showToast('Connection error. Please refresh.', 'error');
        };

        websocket.onclose = () => {
            console.log('WebSocket connection closed.');
            showToast('Disconnected from room.', 'error');
            // Optionally, redirect to dashboard
            stopRoom();
        };
    }

    function handleWebSocketMessage(message) {
        console.log('Received message:', message);
        switch (message.type) {
            case 'ROOM_STATE': // Server sends the full list of participants on join
                participants = new Map(message.participants.map(p => [p.id, p]));
                renderParticipants();
                break;
            case 'USER_JOINED':
                participants.set(message.participant.id, message.participant);
                showToast(`${message.participant.name} joined the room.`);
                renderParticipants();
                break;
            case 'USER_LEFT':
                showToast(`${participants.get(message.userId)?.name || 'A user'} left the room.`);
                participants.delete(message.userId);
                renderParticipants();
                break;
            case 'CHAT_MESSAGE':
                appendChatMessage(message.data);
                break;
            // --- WebRTC Signaling Cases ---
            case 'WEBRTC_OFFER':
                // handleOffer(message.from, message.offer);
                break;
            case 'WEBRTC_ANSWER':
                // handleAnswer(message.from, message.answer);
                break;
            case 'ICE_CANDIDATE':
                // handleIceCandidate(message.from, message.candidate);
                break;
            default:
                console.warn('Unknown message type:', message.type);
        }
    }
    
    function sendWebSocketMessage(type, data) {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({ type, ...data }));
        }
    }

    function stopRoom() {
        if (localStream) localStream.getTracks().forEach(track => track.stop());
        if (websocket) websocket.close();
        
        localStream = null;
        currentRoomId = null;
        participants.clear();
        stopTimer();
        initDashboard();
    }
    
    function renderParticipants() {
        // This function now uses the `participants` Map instead of mockState
        const videoGrid = document.getElementById('video-grid');
        /* ... rest of rendering logic ... */
    }

    function bindRoomControls() {
        document.getElementById('leave-btn').onclick = stopRoom;
        
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const sendAction = () => {
            const message = chatInput.value.trim();
            if (message) {
                sendWebSocketMessage('CHAT_MESSAGE', { text: message });
                chatInput.value = '';
            }
        };
        sendChatBtn.onclick = sendAction;
        chatInput.onkeyup = (e) => { if (e.key === 'Enter') sendAction(); };
        
        /* ... bind other controls like mic, cam, etc. ... */
        // These controls will now also call sendWebSocketMessage to notify others
        // e.g., sendWebSocketMessage('USER_STATE_UPDATE', { micOn: false });
    }

    function appendChatMessage(messageData) {
        const chatMessages = document.getElementById('chat-messages');
        const messageEl = document.createElement('div');
        // Add styling based on if message is from self or others
        messageEl.innerHTML = `<strong>${messageData.senderName}:</strong> ${messageData.text}`;
        chatMessages.appendChild(messageEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // --- Timer and other helpers remain the same ---
    function startTimer() { /* ... */ }
    function stopTimer() { /* ... */ }

    // #################################################################
    // #####                 INITIALIZATION                        #####
    // #################################################################
    initAuth();
});
    </script>
</body>
</html>

