<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudiConnect - Online Group Study (Patched with WebRTC + Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>

    <!-- Firebase (compat) libs used for quick prototyping with Firestore signaling -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .hidden { display: none !important; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .video-participant { aspect-ratio: 16 / 10; overflow: hidden; border-radius: 0.5rem; background-color: #2c2c2e; position: relative; transition: all 0.3s ease; }
        .video-participant video, .video-participant img { width: 100%; height: 100%; object-fit: cover; display:block; }
        .video-participant .name-tag { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .control-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 0.75rem; background-color: #374151; color: white; cursor: pointer; transition: all 0.2s ease; border: none; }
        .control-button:hover { background-color: #4b5563; }
        .control-button.active { background-color: #4f46e5; }
        .control-button.danger { background-color: #dc2626; }
        .control-button.danger:hover { background-color: #ef4444; }
        .control-button i { font-size: 24px; }
        .control-button span { font-size: 10px; margin-top: 4px; }
        .settings-toggle { position: relative; display: inline-block; width: 52px; height: 28px; }
        .settings-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(24px); }
        /* Speaker View */
        #video-grid.speaker-view { grid-template-columns: 1fr; grid-template-rows: 1fr auto; height: 100%; }
        #video-grid.speaker-view .video-participant { grid-row: 2 / 3; grid-column: 1 / 2; width: 120px; height: auto; aspect-ratio: 16 / 10; }
        #video-grid.speaker-view .video-participant.speaker { grid-row: 1 / 2; grid-column: 1 / 2; width: 100%; height: 100%; }
        #video-grid.speaker-view #speaker-rail { display: flex; gap: 0.5rem; overflow-x: auto; padding-top: 0.5rem; }
        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background-color: #2c2c2e; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; margin-bottom: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left: 4px solid #34d399; } .toast.error { border-left: 4px solid #f87171; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="min-h-screen flex flex-col"></div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // #################################################################
    // #####              SIMULATED GLOBAL STATE                   #####
    // #################################################################
    const STORAGE_KEY = 'studiConnectState';
    let mockState;

    function loadStateFromStorage() {
        const storedState = localStorage.getItem(STORAGE_KEY);
        if (storedState) {
            mockState = JSON.parse(storedState);
        } else {
            mockState = {
                users: [{ id: 1, name: 'Student', email: 'student@example.com', password: 'password123' }],
                rooms: {
                    'DEMO123': { password: null, participants: [], files: [{ name: 'Syllabus.pdf' }, { name: 'Chapter1_Notes.docx' }] },
                    'SECRET': { password: 'study', participants: [], files: [] }
                },
                currentUser: null,
                nextUserId: 2
            };
            saveStateToStorage();
        }
    }

    function saveStateToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(mockState)); }

    // Listen for changes from other tabs
    window.addEventListener('storage', (event) => {
        if (event.key === STORAGE_KEY) {
            try { mockState = JSON.parse(event.newValue); } catch (e) { console.error('Failed parsing updated storage', e); return; }
            if (currentRoomId && mockState.rooms && mockState.rooms[currentRoomId]) { renderParticipants(); }
            else if (document.getElementById('dashboard-view')) { renderPublicRooms(); }
        }
    });

    // #################################################################
    // #####              UI TEMPLATES & COMPONENTS                #####
    // #################################################################
    const appContainer = document.getElementById('app-container');
    const toastContainer = document.getElementById('toast-container');

    const templates = {};
    templates.login = `...`;
    templates.signup = `...`;
    templates.dashboard = `...`;
    templates.lobby = `...`;
    templates.room = `...`;

    templates.login = `
        <div id="auth-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-2">StudiConnect Login</h2>
                <p class="text-center text-gray-400 mb-8">Welcome back!</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="you@school.edu" required value="student@example.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="••••••••" required value="password123">
                    </div>
                    <p id="login-error" class="text-red-400 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition-colors duration-300">Login</button>
                    <p class="text-center text-sm text-gray-400 mt-6">Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-400 hover:underline">Sign up</a></p>
                </form>
            </div>
        </div>`;

    templates.signup = `
        <div id="signup-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-2">Create Account</h2>
                <form id="signup-form">
                    <div class="mb-4"><label for="signup-name" class="block text-sm font-medium text-gray-300 mb-2">Full Name</label><input type="text" id="signup-name" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="signup-email" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <div class="mb-6"><label for="signup-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label><input type="password" id="signup-password" class="w-full px-4 py-2 bg-gray-700 rounded-lg" required></div>
                    <p id="signup-error" class="text-red-400 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 rounded-lg">Create Account</button>
                    <p class="text-center text-sm text-gray-400 mt-6">Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-400 hover:underline">Login</a></p>
                </form>
            </div>
        </div>`;

    templates.dashboard = `
        <div id="dashboard-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Welcome, <span id="user-name-display"></span>!</h2>
                    <button id="logout-btn" class="text-sm text-indigo-400 hover:underline">Logout</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-700 p-6 rounded-lg">
                        <h3 class="font-semibold text-lg mb-4">Join by Code</h3>
                        <div class="flex gap-4"><input type="text" id="room-code-input" class="flex-grow px-4 py-2 bg-gray-600 rounded-lg" placeholder="Enter Code"><button id="join-room-btn" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg">Join</button></div>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-lg flex flex-col">
                         <h3 class="font-semibold text-lg mb-4">Start a Session</h3>
                         <button id="create-room-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg mt-auto">Create New Room</button>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-4">Public Rooms</h3>
                    <div id="public-rooms-list" class="space-y-3 max-h-48 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>`;

    templates.lobby = `
        <div id="lobby-view" class="flex-grow flex flex-col items-center justify-center p-4">
            <h2 class="text-3xl font-bold text-white mb-4">Joining Room: <span id="lobby-room-id" class="text-indigo-400"></span></h2>
            <div class="w-full max-w-2xl bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="aspect-video bg-black rounded-lg mb-4 flex items-center justify-center"><video id="lobby-video-preview" autoplay muted class="w-full h-full object-cover rounded-lg"></video></div>
                <div class="flex items-center justify-center gap-4 mb-4">
                    <button id="lobby-mic-btn" class="control-button active" aria-label="Toggle Microphone"><i class="ph ph-microphone"></i></button>
                    <button id="lobby-cam-btn" class="control-button active" aria-label="Toggle Camera"><i class="ph ph-camera"></i></button>
                </div>
                <div class="flex gap-4 items-center">
                    <input type="text" id="lobby-name-input" class="flex-grow px-4 py-2 bg-gray-700 rounded-lg" placeholder="Enter your name">
                    <button id="lobby-join-now-btn" class="bg-green-600 text-white font-semibold px-8 py-2.5 rounded-lg">Join Now</button>
                </div>
            </div>
        </div>`;

    templates.room = `
        <main id="room-view" class="flex-grow flex flex-col md:flex-row h-screen">
            <div class="flex-grow flex flex-col p-4 bg-gray-900">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <div><h1 class="text-xl font-bold">Room: <span id="room-id-display"></span></h1><div class="flex items-center text-sm text-gray-400"><i class="ph-clock mr-1"></i><span id="time-tracker">00:00:00</span></div></div>
                    <div class="flex items-center space-x-2">
                        <button id="layout-toggle-btn" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" aria-label="Toggle Layout"><i class="ph ph-grid-four text-xl"></i></button>
                        <button id="qr-code-btn" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" aria-label="Show QR Code"><i class="ph ph-qr-code text-xl"></i></button>
                        <button id="copy-link-btn" class="flex items-center bg-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-600"><i class="ph-link mr-2"></i>Copy Invite</button>
                    </div>
                </div>
                <div id="media-container" class="flex-grow bg-gray-800 rounded-lg p-2 md:p-4 flex items-center justify-center relative">
                    <div id="video-grid-container" class="w-full h-full"><div id="video-grid" class="video-grid h-full"></div></div>
                    <div id="whiteboard-container" class="hidden w-full h-full bg-white rounded-md"><canvas id="whiteboard-canvas"></canvas><div class="absolute top-2 right-2 p-2 flex gap-2"><input type="color" id="color-picker" value="#000000" class="w-8 h-8 rounded border-none cursor-pointer"><button id="clear-canvas-btn" class="bg-gray-200 p-2 rounded text-gray-800"><i class="ph ph-trash"></i></button></div></div>
                </div>
            </div>
            <aside id="side-panel" class="w-full md:w-80 lg:w-96 bg-gray-800 border-l border-gray-700 flex flex-col p-4 transition-all duration-300 h-1/3 md:h-full">
                <div class="flex border-b border-gray-600 mb-4"><button data-tab="chat" class="tab-btn flex-1 py-2 font-semibold text-indigo-400 border-b-2 border-indigo-400">Chat</button><button data-tab="participants" class="tab-btn flex-1 py-2 font-semibold text-gray-400">Participants (<span id="participant-count">0</span>)</button><button data-tab="files" class="tab-btn flex-1 py-2 font-semibold text-gray-400">Files</button></div>
                <div id="chat-tab" class="flex-grow flex flex-col overflow-y-auto"><div id="chat-messages" class="flex-grow space-y-4 pr-2"></div><div class="mt-4 flex gap-2"><input type="text" id="chat-input" class="flex-grow bg-gray-700 rounded-lg px-4 py-2" placeholder="Type a message..."><button id="send-chat-btn" class="bg-indigo-600 text-white p-2.5 rounded-lg" aria-label="Send Message"><i class="ph ph-paper-plane-tilt text-xl"></i></button></div></div>
                <div id="participants-tab" class="hidden flex-grow overflow-y-auto"><ul id="participants-list" class="space-y-3"></ul></div>
                <div id="files-tab" class="hidden flex-grow overflow-y-auto"><ul id="files-list" class="space-y-2"></ul><p id="no-files-msg" class="text-gray-400 text-center mt-4">No files have been shared yet.</p></div>
            </aside>
            <div id="controls-bar" class="absolute bottom-0 left-1/2 -translate-x-1/2 w-full max-w-2xl p-2 md:p-4 z-10"><div class="bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-2xl flex justify-center gap-2 md:gap-3">
                <button id="mic-btn" class="control-button active" aria-label="Mute/Unmute Mic"><i class="ph ph-microphone"></i><span class="text-[10px]">Mic</span></button>
                <button id="cam-btn" class="control-button active" aria-label="Start/Stop Camera"><i class="ph ph-camera"></i><span class="text-[10px]">Camera</span></button>
                <button id="screen-share-btn" class="control-button" aria-label="Share Screen"><i class="ph ph-desktop"></i><span class="text-[10px]">Share</span></button>
                <button id="whiteboard-btn" class="control-button" aria-label="Toggle Whiteboard"><i class="ph ph-chalkboard-simple"></i><span class="text-[10px]">Board</span></button>
                <button id="file-share-btn" class="control-button" aria-label="Share File"><i class="ph ph-file-arrow-up"></i><span class="text-[10px]">File</span></button>
                <button id="raise-hand-btn" class="control-button" aria-label="Raise Hand"><i class="ph ph-hand"></i><span class="text-[10px]">Hand</span></button>
                <button id="settings-btn" class="control-button" aria-label="Settings"><i class="ph ph-gear"></i><span class="text-[10px]">Settings</span></button>
                <button id="leave-btn" class="control-button danger" aria-label="Leave Room"><i class="ph ph-phone-disconnect"></i><span class="text-[10px]">Leave</span></button>
            </div></div>
        </main>`;

    // #################################################################
    // #####                  UI RENDERING & LOGIC                 #####
    // #################################################################

    // --- App State ---
    let localStream;
    let currentRoomId = null;
    let timerInterval;
    let isDrawing = false;
    let participantStates = {}; // { id: { micOn: true, camOn: true, handRaised: false } }

    // --- Core UI Functions ---
    function renderView(template) { appContainer.innerHTML = template; }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="ph ${type === 'success' ? 'ph-check-circle' : 'ph-x-circle'}"></i><span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000);
    }

    function createModal(id, title, content, footer) {
        const modal = document.createElement('div');
        modal.id = id;
        modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">${title}</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-white"><i class="ph ph-x text-2xl"></i></button>
                </div>
                <div class="modal-content">${content}</div>
                <div class="modal-footer mt-6">${footer}</div>
            </div>`;
        document.body.appendChild(modal);
        modal.querySelector('.close-modal-btn').onclick = () => modal.remove();
        return modal;
    }

    // --- Authentication Flow ---
    function initAuth() { renderView(templates.login); document.getElementById('login-form').onsubmit = handleLogin; document.getElementById('show-signup').onclick = (e) => { e.preventDefault(); initSignup(); }; }
    function initSignup() { renderView(templates.signup); document.getElementById('signup-form').onsubmit = handleSignup; document.getElementById('show-login').onclick = (e) => { e.preventDefault(); initAuth(); }; }
    function handleLogin(e) { e.preventDefault(); const email = e.target.elements['login-email'].value; const password = e.target.elements['login-password'].value; const user = mockState.users.find(u => u.email === email && u.password === password); const errorEl = document.getElementById('login-error'); if (user) { mockState.currentUser = user; saveStateToStorage(); initDashboard(); } else { errorEl.textContent = 'Invalid email or password.'; errorEl.classList.remove('hidden'); } }
    function handleSignup(e) { e.preventDefault(); const name = e.target.elements['signup-name'].value; const email = e.target.elements['signup-email'].value; const password = e.target.elements['signup-password'].value; const errorEl = document.getElementById('signup-error'); if (mockState.users.find(u => u.email === email)) { errorEl.textContent = 'An account with this email already exists.'; errorEl.classList.remove('hidden'); } else { const id = mockState.nextUserId++; mockState.users.push({ id, name, email, password }); saveStateToStorage(); showToast('Account created! Please log in.'); initAuth(); } }

    // --- Dashboard Flow ---
    function initDashboard() {
        renderView(templates.dashboard);
        document.getElementById('user-name-display').textContent = mockState.currentUser.name;
        document.getElementById('logout-btn').onclick = () => { mockState.currentUser = null; saveStateToStorage(); initAuth(); };
        document.getElementById('create-room-btn').onclick = showCreateRoomModal;
        document.getElementById('join-room-btn').onclick = handleJoinRoomAttempt;
        renderPublicRooms();
    }

    function renderPublicRooms() {
        const listContainer = document.getElementById('public-rooms-list');
        if (!listContainer) return;
        const publicRooms = Object.entries(mockState.rooms).filter(([id, room]) => !room.password);
        if (publicRooms.length === 0) { listContainer.innerHTML = `<p class="text-gray-400 text-center py-4">No public rooms are active. Why not start one?</p>`; return; }
        listContainer.innerHTML = '';
        publicRooms.forEach(([roomId, room]) => {
            const roomElement = document.createElement('div');
            roomElement.className = 'bg-gray-600 p-3 rounded-lg flex items-center justify-between hover:bg-gray-500 transition-colors';
            roomElement.innerHTML = `
                <div>
                    <p class="font-semibold text-white">${roomId}</p>
                    <p class="text-xs text-gray-300 flex items-center"><i class="ph ph-users mr-1"></i> ${room.participants.length} participant(s)</p>
                </div>
                <button data-room-id="${roomId}" class="join-public-room-btn bg-indigo-600 text-white font-semibold px-4 py-1.5 text-sm rounded-lg hover:bg-indigo-700">Join</button>
            `;
            listContainer.appendChild(roomElement);
        });
        document.querySelectorAll('.join-public-room-btn').forEach(btn => { btn.onclick = (e) => { const id = e.currentTarget.dataset.roomId; initLobby(id); }; });
    }

    function showCreateRoomModal() {
        const modal = createModal('create-room-modal', 'Create Study Room',
            `<div class="space-y-4">
                <div><label for="room-password-input" class="block text-sm font-medium text-gray-300 mb-2">Room Password (Optional)</label><input type="text" id="room-password-input" class="w-full px-4 py-2 bg-gray-700 rounded-lg" placeholder="Leave blank for public room"></div>
             </div>`,
            `<button id="confirm-create-room-btn" class="w-full bg-green-600 text-white font-semibold py-2.5 rounded-lg">Create and Join</button>`
        );
        modal.querySelector('#confirm-create-room-btn').onclick = () => {
            const password = modal.querySelector('#room-password-input').value;
            const newRoomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            mockState.rooms[newRoomId] = { password: password || null, participants: [], files: [] };
            saveStateToStorage();
            modal.remove();
            initLobby(newRoomId);
        };
    }

    function handleJoinRoomAttempt() {
        const roomId = document.getElementById('room-code-input').value.trim().toUpperCase();
        if (!roomId) return;
        const room = mockState.rooms[roomId];
        if (!room) { showToast('Room not found.', 'error'); return; }
        if (room.password) {
            const modal = createModal('password-modal', `Enter Password for Room ${roomId}`,
                `<div><label for="join-password-input" class="sr-only">Password</label><input type="password" id="join-password-input" class="w-full px-4 py-2 bg-gray-700 rounded-lg" placeholder="Room Password"></div>`,
                `<button id="submit-password-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg">Enter Room</button>`
            );
            modal.querySelector('#submit-password-btn').onclick = () => {
                const enteredPassword = modal.querySelector('#join-password-input').value;
                if (enteredPassword === room.password) { modal.remove(); initLobby(roomId); } else { showToast('Incorrect password.', 'error'); }
            };
        } else {
            initLobby(roomId);
        }
    }

    // --- Lobby Flow ---
    async function initLobby(roomId) {
        renderView(templates.lobby);
        document.getElementById('lobby-room-id').textContent = roomId;
        document.getElementById('lobby-name-input').value = mockState.currentUser.name;
        const videoPreview = document.getElementById('lobby-video-preview');
        const micBtn = document.getElementById('lobby-mic-btn');
        const camBtn = document.getElementById('lobby-cam-btn');

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            videoPreview.srcObject = localStream;
            participantStates[String(mockState.currentUser.id)] = { micOn: true, camOn: true, handRaised: false };
        } catch (err) {
            console.error(err);
            videoPreview.parentElement.innerHTML = `<p class="text-gray-400">Could not access camera/microphone.</p>`;
            participantStates[String(mockState.currentUser.id)] = { micOn: false, camOn: false, handRaised: false };
        }

        micBtn.onclick = () => {
            const key = String(mockState.currentUser.id);
            participantStates[key] = participantStates[key] || { micOn: true, camOn: true, handRaised: false };
            const micOn = !participantStates[key].micOn;
            participantStates[key].micOn = micOn;
            if (localStream && localStream.getAudioTracks().length) localStream.getAudioTracks()[0].enabled = micOn;
            micBtn.classList.toggle('active', micOn);
            micBtn.querySelector('i').className = micOn ? 'ph ph-microphone' : 'ph ph-microphone-slash';
        };

        camBtn.onclick = () => {
            const key = String(mockState.currentUser.id);
            participantStates[key] = participantStates[key] || { micOn: true, camOn: true, handRaised: false };
            const camOn = !participantStates[key].camOn;
            participantStates[key].camOn = camOn;
            if (localStream && localStream.getVideoTracks().length) localStream.getVideoTracks()[0].enabled = camOn;
            camBtn.classList.toggle('active', camOn);
            videoPreview.style.display = camOn ? 'block' : 'none';
            camBtn.querySelector('i').className = camOn ? 'ph ph-camera' : 'ph ph-camera-slash';
        };

        document.getElementById('lobby-join-now-btn').onclick = async () => {
            mockState.currentUser.name = document.getElementById('lobby-name-input').value; // Update name
            saveStateToStorage();
            await startRoom(roomId);
        };
    }

    // --- Main Room Flow ---
    async function startRoom(roomId) {
        currentRoomId = roomId;
        renderView(templates.room);

        // Ensure participants array exists
        if (!mockState.rooms[roomId]) mockState.rooms[roomId] = { password: null, participants: [], files: [] };

        // Add user to room state if not already there (compare by id)
        if (!mockState.rooms[roomId].participants.some(p => p.id === mockState.currentUser.id)) {
            mockState.rooms[roomId].participants.push({ id: mockState.currentUser.id, name: mockState.currentUser.name, email: mockState.currentUser.email });
        }

        // Add ADMIN bot if it's the first real user joining (guard String conversion)
        const participants = mockState.rooms[roomId].participants;
        const realUserCount = participants.filter(p => !String(p.id).startsWith('sim_')).length;
        if (realUserCount === 1 && !participants.some(p => p.id === 'sim_admin')) {
            participants.push({ id: 'sim_admin', name: 'ADMIN' });
            participantStates[String('sim_admin')] = { micOn: true, camOn: true, handRaised: false };
        }

        saveStateToStorage();

        document.getElementById('room-id-display').textContent = roomId;
        renderParticipants();
        renderFiles();
        bindRoomControls();
        startTimer();
        setupWhiteboard();

        // Join WebRTC signaling (Firestore) to exchange offers/answers and ICE
        try {
            await joinRoomWithWebRTC(roomId);
        } catch (e) {
            console.error('WebRTC join failed', e);
            showToast('Realtime connection failed. Check console and Firebase config.', 'error');
        }
    }

    async function stopRoom() {
        // Leave WebRTC room first
        try { await leaveRoomWithWebRTC(currentRoomId); } catch (e) { console.warn('leaveRoomWithWebRTC error', e); }

        if (localStream) localStream.getTracks().forEach(track => track.stop());

        if (mockState.rooms[currentRoomId] && mockState.currentUser) {
            mockState.rooms[currentRoomId].participants = mockState.rooms[currentRoomId].participants.filter(p => p.id !== mockState.currentUser.id);
            saveStateToStorage();
        }

        localStream = null;
        currentRoomId = null;
        stopTimer();
        initDashboard();
    }

    function renderParticipants() {
        if (!currentRoomId || !mockState.rooms[currentRoomId]) return;
        const videoGrid = document.getElementById('video-grid');
        const participantsList = document.getElementById('participants-list');
        const participants = mockState.rooms[currentRoomId].participants || [];
        videoGrid.innerHTML = '';
        participantsList.innerHTML = '';
        document.getElementById('participant-count').textContent = participants.length;

        // ensure participantStates exist for each
        participants.forEach(p => { const key = String(p.id); if (!participantStates[key]) participantStates[key] = { micOn: true, camOn: true, handRaised: false }; });

        // Speaker view: choose first (simple)
        const speakerParticipant = participants[0];

        participants.forEach(p => {
            const isLocal = (p.id === mockState.currentUser.id);
            const state = participantStates[String(p.id)] || { micOn: true, camOn: true, handRaised: false };

            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-participant';
            if (isLocal) videoContainer.classList.add('border-2', 'border-indigo-500');
            if (p === speakerParticipant) videoContainer.classList.add('speaker');

            if (isLocal && localStream) {
                const video = document.createElement('video');
                video.autoplay = true; video.muted = true; video.playsInline = true;
                try { video.srcObject = localStream; } catch (e) { console.warn('Could not set srcObject', e); }
                videoContainer.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = `https://placehold.co/400x250/2c2c2e/ffffff?text=${encodeURIComponent(p.name)}`;
                img.alt = p.name;
                videoContainer.appendChild(img);
            }

            const nameTag = document.createElement('div');
            nameTag.className = 'name-tag';
            nameTag.textContent = `${p.name}${isLocal ? ' (You)' : ''}`;
            videoContainer.appendChild(nameTag);

            if (videoGrid.classList.contains('speaker-view') && p !== speakerParticipant) {
                let rail = document.getElementById('speaker-rail');
                if (!rail) { rail = document.createElement('div'); rail.id = 'speaker-rail'; }
                rail.appendChild(videoContainer);
                if (!document.getElementById('speaker-rail')) videoGrid.appendChild(rail);
            } else {
                videoGrid.appendChild(videoContainer);
            }

            const li = document.createElement('li');
            li.className = 'flex items-center justify-between';
            li.innerHTML = `
                <div class="flex items-center"><span class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm mr-3">${(p.name && p.name.charAt(0)) || '?'}</span><span class="font-medium">${p.name} ${isLocal ? '(You)' : ''}</span></div>
                <div class="flex items-center gap-3">
                   ${state.handRaised ? '<i class="ph ph-hand text-yellow-400 text-xl animate-pulse"></i>' : ''}
                   <i class="ph ${state.micOn ? 'ph-microphone' : 'ph-microphone-slash text-red-400'} text-xl"></i>
                </div>`;
            participantsList.appendChild(li);
        });

        const existingRail = document.getElementById('speaker-rail');
        if (videoGrid.classList.contains('speaker-view') && existingRail && !videoGrid.contains(existingRail)) { videoGrid.appendChild(existingRail); }
    }

    function renderFiles() {
        if (!currentRoomId || !mockState.rooms[currentRoomId]) return;
        const filesList = document.getElementById('files-list');
        const noFilesMsg = document.getElementById('no-files-msg');
        const files = mockState.rooms[currentRoomId].files || [];
        filesList.innerHTML = '';
        if (files.length === 0) { noFilesMsg.classList.remove('hidden'); }
        else { noFilesMsg.classList.add('hidden'); files.forEach(file => { const li = document.createElement('li'); li.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg'; li.innerHTML = `
                    <div class="flex items-center gap-2"><i class="ph ph-file-text text-xl"></i><span class="text-sm font-medium">${file.name}</span></div>
                    <a href="#" class="text-indigo-400 hover:underline text-sm">Download</a>`; filesList.appendChild(li); }); }
    }

    function bindRoomControls() {
        document.getElementById('leave-btn').onclick = stopRoom;
        document.getElementById('mic-btn').onclick = toggleMic;
        document.getElementById('cam-btn').onclick = toggleCam;
        document.getElementById('settings-btn').onclick = showSettingsModal;
        document.getElementById('file-share-btn').onclick = () => { const fileName = `Study_Notes_${Math.floor(Math.random() * 100)}.pdf`; mockState.rooms[currentRoomId].files.push({ name: fileName }); saveStateToStorage(); renderFiles(); showToast(`${fileName} shared.`); };
        document.getElementById('raise-hand-btn').onclick = toggleHand;
        document.getElementById('copy-link-btn').onclick = copyInviteLink;
        document.getElementById('qr-code-btn').onclick = showInviteQR;
        document.getElementById('layout-toggle-btn').onclick = toggleLayout;

        document.querySelectorAll('.tab-btn').forEach(btn => { btn.onclick = (e) => { const tab = e.currentTarget.dataset.tab; document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-indigo-400', 'border-indigo-400'); b.classList.add('text-gray-400'); }); e.currentTarget.classList.add('text-indigo-400', 'border-indigo-400'); ['chat', 'participants', 'files'].forEach(t => { document.getElementById(`${t}-tab`).classList.toggle('hidden', t !== tab); }); }; });
    }

    function toggleMic() { const key = String(mockState.currentUser.id); participantStates[key] = participantStates[key] || { micOn: true, camOn: true, handRaised: false }; participantStates[key].micOn = !participantStates[key].micOn; if (localStream && localStream.getAudioTracks().length) localStream.getAudioTracks()[0].enabled = participantStates[key].micOn; document.getElementById('mic-btn').classList.toggle('active', participantStates[key].micOn); const icon = participantStates[key].micOn ? 'ph ph-microphone' : 'ph ph-microphone-slash'; document.getElementById('mic-btn').querySelector('i').className = icon; renderParticipants(); }

    function toggleCam() { const key = String(mockState.currentUser.id); participantStates[key] = participantStates[key] || { micOn: true, camOn: true, handRaised: false }; participantStates[key].camOn = !participantStates[key].camOn; if (localStream && localStream.getVideoTracks().length) localStream.getVideoTracks()[0].enabled = participantStates[key].camOn; document.getElementById('cam-btn').classList.toggle('active', participantStates[key].camOn); const icon = participantStates[key].camOn ? 'ph ph-camera' : 'ph ph-camera-slash'; document.getElementById('cam-btn').querySelector('i').className = icon; }

    function toggleHand() { const key = String(mockState.currentUser.id); participantStates[key] = participantStates[key] || { micOn: true, camOn: true, handRaised: false }; participantStates[key].handRaised = !participantStates[key].handRaised; document.getElementById('raise-hand-btn').classList.toggle('active', participantStates[key].handRaised); renderParticipants(); }

    function toggleLayout() { const grid = document.getElementById('video-grid'); const icon = document.getElementById('layout-toggle-btn').querySelector('i'); grid.classList.toggle('speaker-view'); if (grid.classList.contains('speaker-view')) icon.className = 'ph ph-speaker-high text-xl'; else icon.className = 'ph ph-grid-four text-xl'; renderParticipants(); }

    function copyInviteLink() { const link = `https://studiconnect.app/join?room=${currentRoomId}`; navigator.clipboard.writeText(link).then(() => showToast('Invite link copied to clipboard!'), () => showToast('Failed to copy link.', 'error')); }

    function showInviteQR() { const link = `https://studiconnect.app/join?room=${currentRoomId}`; const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`; createModal('qr-modal', 'Scan to Join Room', `<div class="flex justify-center"><img src="${qrUrl}" alt="Room QR Code"></div>`, ''); }

    function showSettingsModal() { const modal = createModal('settings-modal', 'Camera & Video Settings', `<div class="space-y-4"> ${['Mirror My Camera', 'Auto Brightness', 'Face Enhancement', 'Background Blur'].map(label => ` <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg"> <label class="font-medium">${label}</label> <label class="settings-toggle"><input type="checkbox"><span class="slider"></span></label> </div>`).join('')} </div>`, ''); }

    // --- Timer ---
    function startTimer() { let seconds = 0; const timerEl = document.getElementById('time-tracker'); if (!timerEl) return; timerEl.textContent = "00:00:00"; timerInterval = setInterval(() => { seconds++; const h = String(Math.floor(seconds / 3600)).padStart(2, '0'); const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0'); const s = String(seconds % 60).padStart(2, '0'); timerEl.textContent = `${h}:${m}:${s}`; }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }

    // --- Whiteboard ---
    function setupWhiteboard() { const whiteboardContainer = document.getElementById('whiteboard-container'); if (!whiteboardContainer) return; const videoGridContainer = document.getElementById('video-grid-container'); const whiteboardBtn = document.getElementById('whiteboard-btn'); whiteboardBtn.onclick = () => { const isWhiteboardOn = !whiteboardContainer.classList.contains('hidden'); whiteboardContainer.classList.toggle('hidden', isWhiteboardOn); videoGridContainer.classList.toggle('hidden', !isWhiteboardOn); whiteboardBtn.classList.toggle('active', !isWhiteboardOn); }; }

    // #################################################################
    // #####               FIREBASE + WEBRTC SIGNALING              #####
    // #################################################################

    // ====== CONFIG: replace with your Firebase project config ======
    const firebaseConfig = {
      apiKey: "PUT_API_KEY",
      authDomain: "PROJECT.firebaseapp.com",
      projectId: "PROJECT",
      storageBucket: "PROJECT.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };

    // initialize firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) { console.warn('Firebase init warning', e); }
    const firestore = firebase.firestore();

    // STUN/TURN config - add TURN servers for production
    const rtcConfig = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] };

    // signaling state
    const localPeerId = String(Math.random()).slice(2, 11);
    const peerConnections = {}; // remoteId -> RTCPeerConnection
    const remoteStreams = {}; // remoteId -> MediaStream
    let currentRoomIdFirebase = null;
    let signalsUnsubscribe = null;

    function createRemoteVideoElement(peerId, displayName = 'Remote') {
      const videoGrid = document.getElementById('video-grid');
      const wrapper = document.createElement('div');
      wrapper.className = 'video-participant';
      wrapper.id = `remote-${peerId}`;
      const video = document.createElement('video');
      video.autoplay = true; video.playsInline = true; video.id = `video-${peerId}`;
      wrapper.appendChild(video);
      const tag = document.createElement('div'); tag.className = 'name-tag'; tag.textContent = displayName; wrapper.appendChild(tag);
      videoGrid.appendChild(wrapper);
      return video;
    }

    async function ensureLocalStreamForWebRTC() { if (localStream) return localStream; try { localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); return localStream; } catch (e) { console.error('getUserMedia failed (webrtc)', e); throw e; } }

    async function sendSignal(roomId, payload) {
      const signalsRef = firestore.collection('rooms').doc(roomId).collection('signals');
      await signalsRef.add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }

    async function joinRoomWithWebRTC(roomId) {
      currentRoomIdFirebase = roomId;
      await ensureLocalStreamForWebRTC();

      const participantsRef = firestore.collection('rooms').doc(roomId).collection('participants');
      await participantsRef.doc(localPeerId).set({ id: localPeerId, name: (mockState.currentUser && mockState.currentUser.name) || 'Guest', joinedAt: firebase.firestore.FieldValue.serverTimestamp() });

      participantsRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
          const doc = change.doc; const remoteId = doc.id; if (remoteId === localPeerId) return;
          if (change.type === 'added') { if (!peerConnections[remoteId]) { createPeerConnectionAndOffer(roomId, remoteId).catch(e => console.error(e)); } }
          else if (change.type === 'removed') { removePeer(remoteId); }
        });
      });

      const signalsRef = firestore.collection('rooms').doc(roomId).collection('signals').orderBy('createdAt');
      signalsUnsubscribe = signalsRef.onSnapshot(async snap => {
        for (const change of snap.docChanges()) {
          if (change.type !== 'added') continue;
          const msg = change.doc.data(); if (msg.from === localPeerId) continue;
          if (msg.to && msg.to !== localPeerId && msg.to !== 'all') continue;
          if (msg.type === 'offer') { await handleIncomingOffer(roomId, msg.from, msg.sdp); }
          else if (msg.type === 'answer') { await handleIncomingAnswer(msg.from, msg.sdp); }
          else if (msg.type === 'ice' && msg.candidate) { const pc = peerConnections[msg.from]; if (pc) { try { await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); } catch (e) { console.warn('Error adding remote ICE', e); } } }
        }
      });

      // create offers to existing participants
      const existing = await participantsRef.get(); existing.forEach(doc => { const pid = doc.id; if (pid !== localPeerId && !peerConnections[pid]) { createPeerConnectionAndOffer(roomId, pid).catch(err => console.error(err)); } });
    }

    async function createPeerConnectionAndOffer(roomId, remotePeerId) {
      if (peerConnections[remotePeerId]) return;
      const pc = new RTCPeerConnection(rtcConfig);
      peerConnections[remotePeerId] = pc;
      if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (evt) => { if (evt.candidate) { sendSignal(roomId, { from: localPeerId, to: remotePeerId, type: 'ice', candidate: evt.candidate.toJSON() }); } };

      pc.ontrack = (evt) => {
        if (!remoteStreams[remotePeerId]) remoteStreams[remotePeerId] = new MediaStream();
        evt.streams[0].getTracks().forEach(t => remoteStreams[remotePeerId].addTrack(t));
        const videoEl = document.getElementById(`video-${remotePeerId}`) || createRemoteVideoElement(remotePeerId);
        try { videoEl.srcObject = remoteStreams[remotePeerId]; } catch (_) { videoEl.src = URL.createObjectURL(remoteStreams[remotePeerId]); }
      };

      const dc = pc.createDataChannel('chat');
      dc.onopen = () => console.log('DC open to', remotePeerId);
      dc.onmessage = (m) => console.log('dc msg', m.data);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await sendSignal(roomId, { from: localPeerId, to: remotePeerId, type: 'offer', sdp: offer.sdp });
    }

    async function handleIncomingOffer(roomId, fromId, sdp) {
      if (!peerConnections[fromId]) {
        const pc = new RTCPeerConnection(rtcConfig); peerConnections[fromId] = pc;
        if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        pc.onicecandidate = (evt) => { if (evt.candidate) sendSignal(roomId, { from: localPeerId, to: fromId, type: 'ice', candidate: evt.candidate.toJSON() }); };
        pc.ontrack = (evt) => { if (!remoteStreams[fromId]) remoteStreams[fromId] = new MediaStream(); evt.streams[0].getTracks().forEach(t => remoteStreams[fromId].addTrack(t)); const videoEl = document.getElementById(`video-${fromId}`) || createRemoteVideoElement(fromId); try { videoEl.srcObject = remoteStreams[fromId]; } catch (_) { videoEl.src = URL.createObjectURL(remoteStreams[fromId]); } };
        pc.ondatachannel = (ev) => { ev.channel.onmessage = (m) => console.log('dc from remote', m.data); };
      }
      const pc = peerConnections[fromId]; await pc.setRemoteDescription({ type: 'offer', sdp }); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await sendSignal(roomId, { from: localPeerId, to: fromId, type: 'answer', sdp: answer.sdp });
    }

    async function handleIncomingAnswer(fromId, sdp) { const pc = peerConnections[fromId]; if (!pc) { console.warn('Got answer for unknown pc', fromId); return; } await pc.setRemoteDescription({ type: 'answer', sdp }); }

    function removePeer(peerId) { if (peerConnections[peerId]) { peerConnections[peerId].close(); delete peerConnections[peerId]; } if (remoteStreams[peerId]) { delete remoteStreams[peerId]; } const el = document.getElementById(`remote-${peerId}`); if (el) el.remove(); }

    async function leaveRoomWithWebRTC(roomId) {
      if (!roomId) return;
      try { await firestore.collection('rooms').doc(roomId).collection('participants').doc(localPeerId).delete(); } catch (e) { console.warn('could not remove participant doc', e); }
      if (signalsUnsubscribe) signalsUnsubscribe(); signalsUnsubscribe = null;
      Object.keys(peerConnections).forEach(pid => { try { peerConnections[pid].close(); } catch (e) {} removePeer(pid); });
      currentRoomIdFirebase = null;
    }

    // #################################################################
    // #####                 INITIALIZATION                        #####
    // #################################################################
    loadStateFromStorage();
    initAuth();
    });
    </script>
</body>
</html>
